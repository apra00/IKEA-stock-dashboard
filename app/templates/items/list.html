{% extends "base.html" %}
{% block title %}Items – IKEA Availability{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0">Items</h2>
  {% if current_user.can_edit_items %}
  <a href="{{ url_for('items.add_item') }}" class="btn btn-primary">
    <i class="bi bi-plus-circle me-1"></i>New item
  </a>
  {% endif %}
</div>

{# extra column for selection checkboxes #}
{% set total_cols = (12 if current_user.is_admin else 11) %}

<div class="card shadow-sm">
  <div class="card-body p-0">
    <form method="post" action="{{ url_for('items.bulk_update') }}" id="bulk-form">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <div class="d-flex flex-wrap justify-content-between align-items-center px-3 pt-3 pb-2 gap-2">
        <div id="bulk-actions" class="d-none">
          <button type="submit"
                  class="btn btn-sm btn-outline-light bg-primary me-2 mb-1"
                  name="bulk_action"
                  value="activate">
            Activate
          </button>
          <button type="submit"
                  class="btn btn-sm btn-outline-light bg-primary me-2 mb-1"
                  name="bulk_action"
                  value="deactivate">
            Deactivate
          </button>
          <button type="submit"
                  class="btn btn-sm btn-outline-danger me-2 mb-1"
                  name="bulk_action"
                  value="delete">
            Delete
          </button>
          <button type="submit"
                  class="btn btn-sm btn-outline-light bg-primary mb-1"
                  name="bulk_action"
                  value="edit">
            Bulk edit…
          </button>
        </div>
        <small class="text-muted d-none" id="bulk-selected-counter">0 items selected</small>
      </div>

      <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th style="width:1%;">
                <input type="checkbox" id="select-all">
              </th>
              {% macro sort_link(label, col_key) -%}
                {%- set is_active = (sort_by == col_key) -%}
                {%- set next_dir = 'desc' if is_active and sort_dir == 'asc' else 'asc' -%}
                <a href="{{ url_for('items.list_items', sort=col_key, dir=next_dir) }}"
                   class="text-decoration-none text-reset">
                  {{ label }}
                  {% if is_active %}
                    <i class="bi bi-caret-{% if sort_dir == 'asc' %}up{% else %}down{% endif %}-fill small"></i>
                  {% endif %}
                </a>
              {%- endmacro %}
              <th>{{ sort_link('Added at', 'added_at') }}</th>
              <th>{{ sort_link('Name', 'name') }}</th>
              <th>{{ sort_link('Product ID', 'product_id') }}</th>
              <th>{{ sort_link('Country', 'country_code') }}</th>
              <th>{{ sort_link('Category', 'folder') }}</th>
              <th>{{ sort_link('Stores', 'stores') }}</th>
              <th>{{ sort_link('Active', 'active') }}</th>
              <th>{{ sort_link('Last stock', 'last_stock') }}</th>
              <th>{{ sort_link('Last probability', 'last_probability') }}</th>
              <th>{{ sort_link('Last checked', 'last_checked') }}</th>
              {% if current_user.is_admin %}
              <th>{{ sort_link('Owner', 'owner') }}</th>
              {% endif %}
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
          {% if folders %}
            {% for folder_name, folder_items in folders.items() %}
              {# Stable key per folder, safe for HTML attr #}
              {% set folder_key = (folder_name|replace(' ', '_')|replace('/', '_')|replace('\\', '_')) %}
              <tr class="table-secondary folder-header"
                  data-folder-group="folder-{{ folder_key }}"
                  data-folder-key="{{ folder_name }}"
                  style="cursor:pointer;">
                <td style="width:1%;">
                  <input type="checkbox"
                         class="folder-select"
                         data-folder-group="folder-{{ folder_key }}">
                </td>
                <td colspan="{{ total_cols - 1 }}">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <i class="bi bi-chevron-down me-1 folder-toggle-icon"></i>
                      <strong>{{ folder_name }}</strong>
                      <span class="ms-2 text-muted small">
                        ({{ folder_items|length }} item{{ '' if folder_items|length == 1 else 's' }})
                      </span>
                    </div>
                  </div>
                </td>
              </tr>

              {# Items in this folder/category #}
              {% for item in folder_items %}
              <tr class="folder-rows"
                  data-folder-group="folder-{{ folder_key }}"
                  data-folder-key="{{ folder_name }}">
                <td>
                  <input type="checkbox"
                         class="item-checkbox"
                         name="item_ids"
                         value="{{ item.id }}">
                </td>
                <td>
                  {% if item.added_at %}
                    {{ item.added_at.strftime('%Y-%m-%d %H:%M') }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>
                  <a href="{{ url_for('items.detail', item_id=item.id) }}">
                    {{ item.name }}
                  </a>
                </td>
                <td>
                  <a href="https://www.ikea.com/hu/hu/p/{{ item.product_id }}/" target="_blank">
                    {{ item.product_id }}
                  </a>
                </td>
                <td>{{ item.country_code }}</td>
                <td>{{ item.folder.name if item.folder else '-' }}</td>
                <td>{{ item.store_ids or "All" }}</td>
                <td>
                  {% if item.is_active %}
                    <span class="badge bg-success">Active</span>
                  {% else %}
                    <span class="badge bg-secondary">Inactive</span>
                  {% endif %}
                </td>
                <td>{{ item.last_stock if item.last_stock is not none else "-" }}</td>
                <td>{{ item.last_probability or "-" }}</td>
                <td>
                  {% if item.last_checked %}
                    {{ item.last_checked.strftime('%Y-%m-%d %H:%M') }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                {% if current_user.is_admin %}
                <td>{{ item.user.username if item.user else '-' }}</td>
                {% endif %}
                <td class="text-end">
                  {% if current_user.can_edit_items %}
                  <a class="btn btn-sm btn-outline-secondary"
                     href="{{ url_for('items.edit_item', item_id=item.id) }}">
                    Edit
                  </a>
                  <form method="post"
                        action="{{ url_for('items.delete_item', item_id=item.id) }}"
                        class="d-inline"
                        onsubmit="return confirm('Delete this item?');">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                  </form>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="{{ total_cols }}" class="text-center text-muted py-3">
                No items yet.
              </td>
            </tr>
          {% endif %}
          </tbody>
        </table>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // -------------------------------
  // Persistence keys (per user)
  // -------------------------------
  const USER_KEY = "{{ current_user.username }}";
  const STATE_KEY = "itemsPageState::" + USER_KEY;

  function loadState() {
    try {
      return JSON.parse(localStorage.getItem(STATE_KEY) || "{}");
    } catch (e) {
      return {};
    }
  }

  function saveState(state) {
    try {
      localStorage.setItem(STATE_KEY, JSON.stringify(state));
    } catch (e) {}
  }

  const state = loadState();
  if (!state.collapsedFolders) state.collapsedFolders = {};
  if (typeof state.scrollY !== "number") state.scrollY = 0;

  // -------------------------------
  // Restore scroll position
  // -------------------------------
  requestAnimationFrame(() => {
    if (state.scrollY && state.scrollY > 0) {
      window.scrollTo(0, state.scrollY);
    }
  });

  // Save scroll position on navigations/reloads
  window.addEventListener("beforeunload", function () {
    state.scrollY = window.scrollY || window.pageYOffset || 0;
    saveState(state);
  });

  // -------------------------------
  // Folder/category collapsible behaviour + persistence
  // -------------------------------
  function setFolderCollapsed(folderKey, collapsed) {
    state.collapsedFolders[folderKey] = collapsed;
    saveState(state);
  }

  function applyFolderState(folderKey, collapsed) {
    const groupHeaders = document.querySelectorAll(
      ".folder-header[data-folder-key='" + folderKey.replace(/'/g, "\\'") + "']"
    );
    const groupRows = document.querySelectorAll(
      ".folder-rows[data-folder-key='" + folderKey.replace(/'/g, "\\'") + "']"
    );

    groupRows.forEach(function (row) {
      row.classList.toggle("d-none", collapsed);
    });

    groupHeaders.forEach(function (header) {
      const icon = header.querySelector(".folder-toggle-icon");
      if (icon) {
        icon.classList.toggle("bi-chevron-down", !collapsed);
        icon.classList.toggle("bi-chevron-right", collapsed);
      }
    });
  }

  // Initial restore of collapsed folders
  document.querySelectorAll(".folder-header").forEach(function (header) {
    const folderKey = header.dataset.folderKey;
    const collapsed = !!state.collapsedFolders[folderKey];
    applyFolderState(folderKey, collapsed);
  });

  // Toggle on click + persist
  document.querySelectorAll(".folder-header").forEach(function (header) {
    header.addEventListener("click", function (evt) {
      // Avoid toggling when clicking the folder checkbox
      if (evt.target.tagName === "INPUT" || evt.target.closest("input")) {
        return;
      }

      const folderKey = header.dataset.folderKey;
      const rows = document.querySelectorAll(
        ".folder-rows[data-folder-key='" + folderKey.replace(/'/g, "\\'") + "']"
      );

      let anyVisible = false;
      rows.forEach(function (row) {
        if (!row.classList.contains("d-none")) anyVisible = true;
      });

      const newCollapsed = anyVisible; // if any visible -> collapse
      applyFolderState(folderKey, newCollapsed);
      setFolderCollapsed(folderKey, newCollapsed);
    });
  });

  // -------------------------------
  // Bulk selection logic (unchanged)
  // -------------------------------
  const selectAll = document.getElementById("select-all");
  const bulkForm = document.getElementById("bulk-form");
  const counter = document.getElementById("bulk-selected-counter");
  const bulkActions = document.getElementById("bulk-actions");
  const itemCheckboxes = Array.from(document.querySelectorAll(".item-checkbox"));
  let lastItemCheckbox = null;

  function updateCounter() {
    let count = 0;
    document.querySelectorAll(".item-checkbox:checked").forEach(function () {
      count += 1;
    });

    if (counter) {
      counter.textContent = count + " item" + (count === 1 ? "" : "s") + " selected";
      counter.classList.toggle("d-none", count === 0);
    }

    if (bulkActions) {
      bulkActions.classList.toggle("d-none", count === 0);
    }
  }

  // Global select-all
  if (selectAll) {
    selectAll.addEventListener("change", function () {
      const checked = selectAll.checked;
      document.querySelectorAll(".item-checkbox").forEach(function (cb) {
        cb.checked = checked;
      });
      // Also sync folder-level checkboxes
      document.querySelectorAll(".folder-select").forEach(function (fcb) {
        fcb.checked = checked;
      });
      updateCounter();
    });
  }

  // Shift+click range selection for item checkboxes
  function handleItemCheckboxClick(e) {
    const cb = e.target;
    if (e.shiftKey && lastItemCheckbox && lastItemCheckbox !== cb) {
      const checkboxes = itemCheckboxes;
      const start = checkboxes.indexOf(lastItemCheckbox);
      const end = checkboxes.indexOf(cb);
      if (start !== -1 && end !== -1) {
        const [from, to] = start < end ? [start, end] : [end, start];
        const checkedState = lastItemCheckbox.checked;
        for (let i = from; i <= to; i++) {
          checkboxes[i].checked = checkedState;
        }
      }
    }
    lastItemCheckbox = cb;
    updateCounter();
  }

  itemCheckboxes.forEach(function (cb) {
    cb.addEventListener("click", handleItemCheckboxClick);
  });

  // Category-level select all / deselect all
  document.querySelectorAll(".folder-select").forEach(function (fcb) {
    fcb.addEventListener("change", function (evt) {
      const checked = fcb.checked;
      const group = fcb.dataset.folderGroup;
      const rows = document.querySelectorAll(
        ".folder-rows[data-folder-group='" + group + "']"
      );
      rows.forEach(function (row) {
        const cb = row.querySelector(".item-checkbox");
        if (cb) {
          cb.checked = checked;
        }
      });
      updateCounter();
      evt.stopPropagation();
    });
  });

  // Bulk form submit: require at least one item, confirm on delete
  if (bulkForm) {
    bulkForm.addEventListener("submit", function (e) {
      const selected = document.querySelectorAll(".item-checkbox:checked").length;
      if (selected === 0) {
        e.preventDefault();
        alert("Please select at least one item.");
        return;
      }

      const submitter = e.submitter || null;
      const action = submitter ? submitter.value : "";

      if (action === "delete") {
        if (!confirm("Delete the selected items?")) {
          e.preventDefault();
          return;
        }
      }
    });
  }

  // Initial state
  updateCounter();
});
</script>

{% endblock %}

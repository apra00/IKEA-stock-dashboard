{% extends "base.html" %}
{% block title %}Items – IKEA Availability{% endblock %}

{% block head_extra %}
<style>
  .items-hero {
    background: radial-gradient(1200px circle at 0% 0%, #0d6efd10, transparent 40%),
                radial-gradient(1200px circle at 100% 0%, #20c99715, transparent 40%),
                linear-gradient(180deg, #ffffff, #f8fafc);
    border: 1px solid #e5edf6;
  }
  .items-hero h2 { letter-spacing: .01em; }
  .chip {
    font-size: .75rem;
    border-radius: 999px;
    padding: .2rem .6rem;
    background: #f3f5f9;
    color:#6c757d;
    border: 1px solid #e1e5ee;
    display: inline-flex;
    align-items: center;
    gap: .35rem;
    white-space: nowrap;
  }
  .folder-header {
    background: linear-gradient(90deg, #f3f6ff, #f8fbff);
    border-top: 1px solid #e0e7f5;
    border-bottom: 1px solid #e0e7f5;
  }
  .folder-header:hover { background: linear-gradient(90deg, #e7efff, #f3f7ff); }
  .folder-toggle-icon { transition: transform .15s ease; }
  .table-items thead th {
    font-size: .75rem;
    text-transform: uppercase;
    letter-spacing: .06em;
    color:#6c757d;
    white-space: nowrap;
  }
  .table-items tbody td { vertical-align: middle; font-size: .9rem; }
  .bulk-toolbar { border-bottom: 1px solid #edf0f7; background: #f8fafc; }
  .bulk-toolbar-active { background: #102a43; color: #fff; }
  .bulk-toolbar-active .btn { border-radius: 999px; }
  .sticky-header-wrapper {
    position: sticky; top: 0; z-index: 9;
  }
  .badge-active {
    background: rgba(25,135,84,0.12);
    color: #198754;
    border-radius:999px;
    padding: .25rem .55rem;
    font-size:.75rem;
  }
  .badge-inactive {
    background: rgba(108,117,125,0.15);
    color: #6c757d;
    border-radius:999px;
    padding: .25rem .55rem;
    font-size:.75rem;
  }
  .item-name-link { font-weight: 600; }
  .item-name-link:hover { text-decoration: underline; }
  .row-hover-soft tbody tr:hover:not(.folder-header) { background: #f8fbff; }
  .floating-scroll-top {
    position: fixed; right: 1.25rem; bottom: 1.25rem; z-index: 10; display: none;
  }

  /* -------- Mobile friendliness -------- */
  @media (max-width: 992px) {
    .items-hero { padding: 1rem !important; }
    .items-hero .btn { width: 100%; }
  }

  @media (max-width: 768px) {
    /* turn item rows into cards */
    .table-items thead { display:none; }
    .table-items tbody, .table-items tr, .table-items td { display:block; width:100%; }
    .table-items tr.folder-header { display: table-row; }
    .table-items tr.folder-header td { display: table-cell; }

    .table-items tr.folder-rows {
      background:#fff;
      border-bottom: none;
      margin: .6rem .6rem .8rem;
      border: 1px solid #e9eef5;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 3px 10px rgba(16,42,67,.04);
    }

    .table-items tr.folder-rows td {
      padding: .5rem .9rem;
      border: none;
      display:flex;
      justify-content: space-between;
      align-items: center;
      gap: .75rem;
    }

    .table-items tr.folder-rows td::before {
      content: attr(data-label);
      font-size: .72rem;
      text-transform: uppercase;
      letter-spacing: .05em;
      color:#8a94a6;
      font-weight: 600;
      flex: 0 0 auto;
    }

    /* first column (checkbox) + last column (actions) special */
    .table-items tr.folder-rows td.select-col {
      background:#f8fafc;
      border-bottom:1px solid #eef2f7;
      padding: .6rem .9rem;
    }
    .table-items tr.folder-rows td.select-col::before { content:"Select"; }

    .table-items tr.folder-rows td.actions-col {
      background:#f8fafc;
      border-top:1px solid #eef2f7;
      padding: .6rem .9rem;
    }
    .table-items tr.folder-rows td.actions-col::before { content:"Actions"; }

    .table-items tr.folder-rows td.name-col {
      align-items:flex-start;
    }

    .table-items tr.folder-rows td.name-col::before { content:"Item"; }
    .table-items tr.folder-rows td.name-col .small { margin-top: .15rem; }

    /* shrink some text */
    .table-items tbody td { font-size: .95rem; }
    .table-items code { font-size: .9rem; }
  }

  @media (max-width: 420px) {
    .chip { font-size: .7rem; }
    .table-items tr.folder-rows { margin: .5rem .4rem .7rem; }
  }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
  <div>
    <h2 class="mb-0">Items</h2>
    <div class="text-muted small">Your tracked IKEA products.</div>
  </div>

  <div class="d-flex gap-2">
    {% if current_user.can_edit_items %}
      <a href="{{ url_for('items.import_export_page') }}"
         class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left-right me-1"></i>Import / Export
      </a>
      <a href="{{ url_for('items.add_item') }}"
         class="btn btn-primary btn-sm">
        <i class="bi bi-plus-circle me-1"></i>Add item
      </a>
    {% endif %}
  </div>
</div>

{% set total_cols = (13 if current_user.is_admin else 12) %}

{# --- TAG RIBBON (NEW) ------------------------------------------ #}
{% if tag_ribbon_tags %}
  <div class="mb-3">
    <div class="d-flex flex-wrap align-items-center gap-2">
      <div class="small text-muted me-1">Filter by tag:</div>

      {# "All" reset chip #}
      <a href="{{ url_for('items.list_items') }}"
         class="chip text-decoration-none {% if not tag_filter %}fw-semibold{% endif %}">
        All
      </a>

      {# individual tag chips #}
      {% for tag in tag_ribbon_tags %}
        <a href="{{ url_for('items.list_items', tag=tag.name) }}"
           class="chip text-decoration-none
                  {% if tag_filter == tag.name %}bg-primary text-white border-0{% endif %}">
          <span>{{ tag.name }}</span>
          <span class="badge rounded-pill bg-light text-muted border">
            {{ tag.count }}
          </span>
        </a>
      {% endfor %}
    </div>
  </div>
{% endif %}
{# --- END TAG RIBBON -------------------------------------------- #}

<div class="card shadow-sm">
  <div class="card-body p-0">
    <form method="post" action="{{ url_for('items.bulk_edit') }}" id="bulk-form">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <div class="px-3 pt-3 pb-2 bulk-toolbar">
        <div class="d-flex flex-wrap align-items-center gap-2">
          <div id="bulk-actions" class="d-flex flex-wrap gap-2 align-items-center d-none">
            <span class="small me-1 text-light-emphasis">Bulk actions:</span>

            <button type="submit"
                    class="btn btn-sm btn-outline-light bg-primary"
                    name="bulk_action"
                    value="activate">
              <i class="bi bi-toggle-on me-1"></i>Activate
            </button>

            <button type="submit"
                    class="btn btn-sm btn-outline-light bg-primary"
                    name="bulk_action"
                    value="deactivate">
              <i class="bi bi-toggle-off me-1"></i>Deactivate
            </button>

            <button type="submit"
                    class="btn btn-sm btn-outline-danger"
                    name="bulk_action"
                    value="delete">
              <i class="bi bi-trash me-1"></i>Delete
            </button>

            <button type="submit"
                    class="btn btn-sm btn-outline-light bg-primary"
                    name="bulk_action"
                    value="edit">
              <i class="bi bi-pencil-square me-1"></i>Bulk edit…
            </button>

            <!-- EXPORT (NEW) -->
            <div class="btn-group ms-1">
              <button type="button"
                      class="btn btn-sm btn-outline-success dropdown-toggle"
                      data-bs-toggle="dropdown"
                      aria-expanded="false">
                <i class="bi bi-download me-1"></i>Export…
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item export-action" data-format="csv" href="#">CSV</a></li>
                <li><a class="dropdown-item export-action" data-format="xlsx" href="#">Excel (.xlsx)</a></li>
                <li><a class="dropdown-item export-action" data-format="json" href="#">JSON</a></li>
              </ul>
            </div>
          </div>

          <small class="text-muted d-none ms-auto" id="bulk-selected-counter">
            0 items selected
          </small>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th style="width:1%;">
                <input type="checkbox" id="select-all">
              </th>

              {% macro sort_link(label, col_key) -%}
                {%- set is_active = (sort_by == col_key) -%}
                {%- set next_desc = '0' -%}
                {%- if is_active and not sort_desc -%}
                  {%- set next_desc = '1' -%}
                {%- elif not is_active and sort_desc -%}
                  {%- set next_desc = '1' -%}
                {%- endif -%}
                <a href="{{ url_for('items.list_items', sort=col_key, desc=next_desc) }}"
                  class="text-decoration-none text-reset">
                  {{ label }}
                  {% if is_active %}
                    <i class="bi bi-caret-{% if sort_desc %}down{% else %}up{% endif %}-fill small"></i>
                  {% endif %}
                </a>
              {%- endmacro %}

              <th>{{ sort_link('Created at', 'created_at') }}</th>
              <th>{{ sort_link('Name', 'name') }}</th>
              <th>{{ sort_link('Product ID', 'product_id') }}</th>
              <th>{{ sort_link('Stores', 'stores') }}</th>
              <th>{{ sort_link('Active', 'active') }}</th>
              <th>{{ sort_link('Last stock', 'last_stock') }}</th>
              <th>{{ sort_link('Last checked', 'last_checked') }}</th>
              <th>Tags</th>

              {% if current_user.is_admin %}
              <th>{{ sort_link('Owner', 'owner') }}</th>
              {% endif %}

              <th class="text-end">Actions</th>
            </tr>
          </thead>

          <tbody>
          {% if folders %}
            {% for folder_name, folder_items in folders.items() %}
              {% set folder_idx = loop.index %}

              <!-- Folder header -->
              <tr class="table-secondary folder-header"
                  data-folder-group="folder-{{ folder_idx }}"
                  data-folder-key="{{ folder_name }}"
                  style="cursor:pointer;">
                <td style="width:1%;">
                  <input type="checkbox"
                         class="folder-select"
                         data-folder-group="folder-{{ folder_idx }}">
                </td>
                <td colspan="{{ total_cols - 1 }}">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <i class="bi bi-chevron-down me-1 folder-toggle-icon"></i>
                      <strong>{{ folder_name }}</strong>
                      <span class="ms-2 text-muted small">
                        ({{ folder_items|length }} item{{ '' if folder_items|length == 1 else 's' }})
                      </span>
                    </div>
                    <div class="small text-muted d-none d-md-flex gap-3">
                      <span>
                        Active:
                        {{ folder_items|selectattr('is_active')|list|length }}
                      </span>
                      {% set folder_above = folder_items
                          |selectattr('notify_enabled')
                          |selectattr('notify_threshold', 'ne', none)
                          |list %}
                      {% set folder_below = folder_items
                          |selectattr('notify_bellow_enabled')
                          |selectattr('notify_bellow_threshold', 'ne', none)
                          |list %}
                      <span>
                        Notifs:
                        {{ folder_above|length }} ↑ / {{ folder_below|length }} ↓
                      </span>
                    </div>
                  </div>
                </td>
              </tr>

              <!-- Items in folder -->
              {% for item in folder_items %}
              <tr class="folder-rows"
                  data-folder-group="folder-{{ folder_idx }}"
                  data-folder-key="{{ folder_name }}">
                <td>
                  <input type="checkbox"
                         class="item-checkbox"
                         name="item_ids"
                         value="{{ item.id }}">
                </td>

                <td class="text-muted small">
                  {% if item.created_at %}
                    {{ item.created_at.strftime('%Y-%m-%d %H:%M') }}
                  {% endif %}
                </td>

                <td>
                  <a class="fw-semibold text-decoration-none"
                     href="{{ url_for('items.detail', item_id=item.id) }}">
                    {{ item.name }}
                  </a>
                  {% set above_on = item.notify_enabled and item.notify_threshold is not none %}
                  {% set below_on = item.notify_bellow_enabled and item.notify_bellow_threshold is not none %}
                  {% if above_on or below_on %}
                    <span class="badge bg-warning text-dark ms-1">
                      {% if above_on %}↑ ≥ {{ item.notify_threshold }}{% endif %}
                      {% if below_on %}
                        {% if above_on %} · {% endif %}
                        ↓ &lt; {{ item.notify_bellow_threshold }}
                      {% endif %}
                    </span>
                  {% endif %}
                </td>

                <td>
                  {{ item.product_id }}
                  <a href="https://www.ikea.com/{{ item.country_code|lower }}/hu/p/{{ item.product_id }}/"
                     target="_blank" class="ms-1 text-muted">
                    <i class="bi bi-box-arrow-up-right"></i>
                  </a>
                </td>
                <td class="text-muted small">{{ item.store_ids or "—" }}</td>

                <td>
                  {% if item.is_active %}
                    <span class="badge bg-success-subtle text-success border">Active</span>
                  {% else %}
                    <span class="badge bg-secondary-subtle text-secondary border">Inactive</span>
                  {% endif %}
                </td>

                <td class="{% if item.last_stock and item.last_stock > 0 %}text-success fw-semibold{% endif %}">
                  {{ item.last_stock if item.last_stock is not none else "—" }}
                </td>
                <td class="text-muted small">
                  {% if item.last_checked %}
                    {{ item.last_checked.strftime('%Y-%m-%d %H:%M') }}
                  {% else %}
                    never
                  {% endif %}
                </td>
                <td>
                  {% for tag in item.tags %}
                    <span class="chip">{{ tag.name }}</span>
                  {% endfor %}
                </td>

                {% if current_user.is_admin %}
                <td class="text-muted small">
                  {{ item.user.username if item.user else "—" }}
                </td>
                {% endif %}

                <td class="text-end text-nowrap">
                  <a href="{{ url_for('items.edit_item', item_id=item.id) }}"
                     class="btn btn-sm btn-outline-primary me-1">Edit</a>
                  {% if current_user.can_edit_items %}
                  <form method="post"
                        action="{{ url_for('items.delete_item', item_id=item.id) }}"
                        class="d-inline"
                        onsubmit="return confirm('Delete this item?');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                  </form>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="{{ total_cols }}" class="text-center text-muted py-3">
                No items yet.
              </td>
            </tr>
          {% endif %}
          </tbody>
        </table>
      </div>
    </form>
  </div>
</div>

<!-- Hidden export form (NEW) -->
<form id="export-form" method="post" action="{{ url_for('items.export_items') }}" class="d-none">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <input type="hidden" name="format" id="export-format-hidden" value="csv">
  <div id="export-ids"></div>
</form>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // -------------------------------
  // Persistence keys (per user)
  // -------------------------------
  const USER_KEY = "{{ current_user.username }}";
  const STATE_KEY = "itemsPageState::" + USER_KEY;

  function loadState() {
    try {
      return JSON.parse(localStorage.getItem(STATE_KEY) || "{}");
    } catch (e) {
      return {};
    }
  }

  function saveState(state) {
    try {
      localStorage.setItem(STATE_KEY, JSON.stringify(state));
    } catch (e) {}
  }

  const state = loadState();
  if (!state.collapsedFolders) state.collapsedFolders = {};
  if (typeof state.scrollY !== "number") state.scrollY = 0;

  // -------------------------------
  // Restore scroll position
  // -------------------------------
  requestAnimationFrame(() => {
    if (state.scrollY && state.scrollY > 0) {
      window.scrollTo(0, state.scrollY);
    }
  });

  window.addEventListener("beforeunload", function () {
    state.scrollY = window.scrollY || window.pageYOffset || 0;
    saveState(state);
  });

  // -------------------------------
  // Folder collapsible behaviour + persistence
  // -------------------------------
  function setFolderCollapsed(folderKey, collapsed) {
    state.collapsedFolders[folderKey] = collapsed;
    saveState(state);
  }

  function applyFolderState(folderKey, collapsed) {
    const groupHeaders = document.querySelectorAll(
      ".folder-header[data-folder-key='" + folderKey.replace(/'/g, "\\'") + "']"
    );
    const groupRows = document.querySelectorAll(
      ".folder-rows[data-folder-key='" + folderKey.replace(/'/g, "\\'") + "']"
    );

    groupRows.forEach(function (row) {
      row.classList.toggle("d-none", collapsed);
    });

    groupHeaders.forEach(function (header) {
      const icon = header.querySelector(".folder-toggle-icon");
      if (icon) {
        icon.classList.toggle("bi-chevron-down", !collapsed);
        icon.classList.toggle("bi-chevron-right", collapsed);
      }
    });
  }

  // Initial restore of collapsed folders
  document.querySelectorAll(".folder-header").forEach(function (header) {
    const folderKey = header.dataset.folderKey;
    const collapsed = !!state.collapsedFolders[folderKey];
    applyFolderState(folderKey, collapsed);
  });

  // Toggle on header click (except checkbox)
  document.querySelectorAll(".folder-header").forEach(function (header) {
    header.addEventListener("click", function (evt) {
      if (evt.target.tagName === "INPUT" || evt.target.closest("input")) {
        return;
      }
      const folderKey = header.dataset.folderKey;
      const rows = document.querySelectorAll(
        ".folder-rows[data-folder-key='" + folderKey.replace(/'/g, "\\'") + "']"
      );

      let anyVisible = false;
      rows.forEach(function (row) {
        if (!row.classList.contains("d-none")) anyVisible = true;
      });

      const newCollapsed = anyVisible;
      applyFolderState(folderKey, newCollapsed);
      setFolderCollapsed(folderKey, newCollapsed);
    });
  });

  // -------------------------------
  // Bulk selection & counters
  // -------------------------------
  const selectAll = document.getElementById("select-all");
  const bulkForm = document.getElementById("bulk-form");
  const counter = document.getElementById("bulk-selected-counter");
  const bulkActions = document.getElementById("bulk-actions");
  const itemCheckboxes = Array.from(document.querySelectorAll(".item-checkbox"));
  const toolbar = document.querySelector(".bulk-toolbar");
  let lastItemCheckbox = null;

  function updateCounter() {
    let count = 0;
    document.querySelectorAll(".item-checkbox:checked").forEach(function () {
      count += 1;
    });

    if (counter) {
      counter.textContent = count + " item" + (count === 1 ? "" : "s") + " selected";
      counter.classList.toggle("d-none", count === 0);
    }

    if (bulkActions) {
      bulkActions.classList.toggle("d-none", count === 0);
    }

    if (toolbar) {
      toolbar.classList.toggle("bulk-toolbar-active", count > 0);
    }
  }

  if (selectAll) {
    selectAll.addEventListener("change", function () {
      const checked = selectAll.checked;
      document.querySelectorAll(".item-checkbox").forEach(function (cb) {
        cb.checked = checked;
      });
      document.querySelectorAll(".folder-select").forEach(function (fcb) {
        fcb.checked = checked;
      });
      updateCounter();
    });
  }

  function handleItemCheckboxClick(e) {
    const cb = e.target;
    if (e.shiftKey && lastItemCheckbox && lastItemCheckbox !== cb) {
      const checkboxes = itemCheckboxes;
      const start = checkboxes.indexOf(lastItemCheckbox);
      const end = checkboxes.indexOf(cb);
      if (start !== -1 && end !== -1) {
        const [from, to] = start < end ? [start, end] : [end, start];
        const checkedState = lastItemCheckbox.checked;
        for (let i = from; i <= to; i++) {
          checkboxes[i].checked = checkedState;
        }
      }
    }
    lastItemCheckbox = cb;
    updateCounter();
  }

  itemCheckboxes.forEach(function (cb) {
    cb.addEventListener("click", handleItemCheckboxClick);
  });

  // Category-level select all / deselect all
  document.querySelectorAll(".folder-select").forEach(function (fcb) {
    fcb.addEventListener("change", function (evt) {
      const checked = fcb.checked;
      const group = fcb.dataset.folderGroup;
      const rows = document.querySelectorAll(
        ".folder-rows[data-folder-group='" + group + "']"
      );
      rows.forEach(function (row) {
        const cb = row.querySelector(".item-checkbox");
        if (cb) {
          cb.checked = checked;
        }
      });
      updateCounter();
      evt.stopPropagation();
    });
  });

  // Bulk form submit: require at least one item, confirm on delete
  if (bulkForm) {
    bulkForm.addEventListener("submit", function (e) {
      const selected = document.querySelectorAll(".item-checkbox:checked").length;
      if (selected === 0) {
        e.preventDefault();
        alert("Please select at least one item.");
        return;
      }

      const actionBtn = e.submitter;
      const action = actionBtn ? actionBtn.value : "";
      if (action === "delete") {
        const ok = confirm("Delete selected items?");
        if (!ok) {
          e.preventDefault();
          return;
        }
      }
    });
  }

  // -------------------------------
  // Export handler (NEW)
  // -------------------------------
  const exportForm = document.getElementById("export-form");
  const exportIds = document.getElementById("export-ids");
  const exportFmtHidden = document.getElementById("export-format-hidden");

  function selectedIds() {
    return itemCheckboxes.filter(cb => cb.checked).map(cb => cb.value);
  }

  document.querySelectorAll(".export-action").forEach(function (a) {
    a.addEventListener("click", function (e) {
      e.preventDefault();
      const ids = selectedIds();
      if (!ids.length) return;

      exportIds.innerHTML = "";
      ids.forEach(id => {
        const inp = document.createElement("input");
        inp.type = "hidden";
        inp.name = "item_ids";
        inp.value = id;
        exportIds.appendChild(inp);
      });

      exportFmtHidden.value = a.dataset.format;
      exportForm.submit();
    });
  });

  updateCounter();
});
</script>

{% endblock %}

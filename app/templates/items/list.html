{% extends "base.html" %}
{% block title %}Items â€“ IKEA Availability{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0">Items</h2>
  {% if current_user.can_edit_items %}
  <a href="{{ url_for('items.add_item') }}" class="btn btn-primary">
    <i class="bi bi-plus-circle me-1"></i>New item
  </a>
  {% endif %}
</div>

{% set total_cols = 11 if current_user.is_admin else 10 %}

<div class="card shadow-sm">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0 align-middle">
        <thead class="table-light">
          <tr>
            {% macro sort_link(label, col_key) -%}
              {%- set is_active = (sort_by == col_key) -%}
              {%- set next_dir = 'desc' if is_active and sort_dir == 'asc' else 'asc' -%}
              <a href="{{ url_for('items.list_items', sort=col_key, dir=next_dir) }}"
                 class="text-decoration-none text-reset">
                {{ label }}
                {% if is_active %}
                  {% if sort_dir == 'asc' %}
                    <i class="bi bi-caret-up-fill small"></i>
                  {% else %}
                    <i class="bi bi-caret-down-fill small"></i>
                  {% endif %}
                {% endif %}
              </a>
            {%- endmacro %}

            <th>{{ sort_link('Added at', 'added_at') }}</th>
            <th>{{ sort_link('Name', 'name') }}</th>
            <th>{{ sort_link('Product ID', 'product_id') }}</th>
            <th>{{ sort_link('Country', 'country_code') }}</th>
            <th>{{ sort_link('Folder', 'folder') }}</th>
            <th>{{ sort_link('Stores', 'stores') }}</th>
            <th>{{ sort_link('Active', 'active') }}</th>
            <th>{{ sort_link('Last stock', 'last_stock') }}</th>
            <th>Probability</th>
            <th>{{ sort_link('Last checked', 'last_checked') }}</th>
            {% if current_user.is_admin %}
            <th>{{ sort_link('Owner', 'owner') }}</th>
            {% endif %}
            <th></th>
          </tr>
        </thead>
        <tbody>
        {% if folders %}
          {% for folder_name, folder_items in folders.items() %}
            {% set folder_idx = loop.index %}
            <!-- Folder header row -->
            <tr class="table-secondary folder-header"
                data-folder-group="folder-{{ folder_idx }}"
                style="cursor: pointer;">
              <td colspan="{{ total_cols }}">
                <i class="bi bi-chevron-down me-2 folder-toggle-icon"></i>
                <strong>{{ folder_name }}</strong>
                <span class="text-muted ms-2">({{ folder_items|length }} item{{ '' if folder_items|length == 1 else 's' }})</span>
              </td>
            </tr>

            <!-- Items in this folder -->
            {% for item in folder_items %}
            <tr class="folder-rows"
                data-folder-group="folder-{{ folder_idx }}">
              <td>
              {% if item.added_at %}
                {{ item.added_at.strftime('%Y-%m-%d %H:%M') }}
              {% else %}
                -
              {% endif %}
            </td>
            <td>
                <a href="{{ url_for('items.detail', item_id=item.id) }}">
                  {{ item.name }}
                </a>
              </td>
              <td>{{ item.product_id }}</td>
              <td>{{ item.country_code }}</td>
              <td>{{ item.folder.name if item.folder else '-' }}</td>
              <td>{{ item.store_ids or "All" }}</td>
              <td>
                {% if item.is_active %}
                  <span class="badge bg-success">Active</span>
                {% else %}
                  <span class="badge bg-secondary">Inactive</span>
                {% endif %}
              </td>
              <td>{{ item.last_stock if item.last_stock is not none else "-" }}</td>
              <td>{{ item.last_probability or "-" }}</td>
              <td>
                {% if item.last_checked %}
                  {{ item.last_checked.strftime('%Y-%m-%d %H:%M') }}
                {% else %}
                  -
                {% endif %}
              </td>
              {% if current_user.is_admin %}
              <td>{{ item.user.username if item.user else '-' }}</td>
              {% endif %}
              <td class="text-end">
                {% if current_user.can_edit_items %}
                <a class="btn btn-sm btn-outline-secondary"
                   href="{{ url_for('items.edit_item', item_id=item.id) }}">
                  Edit
                </a>
                <form method="post"
                      action="{{ url_for('items.delete_item', item_id=item.id) }}"
                      class="d-inline"
                      onsubmit="return confirm('Delete this item?');">
                  <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                </form>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="{{ total_cols }}" class="text-center text-muted py-3">
              No items yet.
            </td>
          </tr>
        {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll(".folder-header").forEach(function (header) {
    header.addEventListener("click", function () {
      const group = header.dataset.folderGroup;
      const rows = document.querySelectorAll(
        ".folder-rows[data-folder-group='" + group + "']"
      );

      let anyVisible = false;
      rows.forEach(function (row) {
        if (!row.classList.contains("d-none")) {
          anyVisible = true;
        }
      });

      // If any are visible, hide all; otherwise show all
      rows.forEach(function (row) {
        if (anyVisible) {
          row.classList.add("d-none");
        } else {
          row.classList.remove("d-none");
        }
      });

      const icon = header.querySelector(".folder-toggle-icon");
      if (icon) {
        icon.classList.toggle("bi-chevron-down", !anyVisible);
        icon.classList.toggle("bi-chevron-right", anyVisible);
      }
    });
  });
});
</script>

{% endblock %}

{% extends "base.html" %}
{% block title %}Import mapping – IKEA Availability{% endblock %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
  <div>
    <h2 class="mb-1">Import mapping</h2>
    <div class="text-muted small">
      Map your file’s columns to IKEA Checker fields.
      {% if not has_header %}
        <span class="ms-1 badge bg-warning text-dark">Headerless mode</span>
      {% endif %}
    </div>
  </div>
  <a href="{{ url_for('items.import_export_page') }}" class="btn btn-outline-secondary btn-sm">
    <i class="bi bi-arrow-left me-1"></i>Back
  </a>
</div>

<form method="post" action="{{ url_for('items.import_submit') }}">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

  <div class="card shadow-sm rounded-4 mb-3">
    <div class="card-body">
      <h5 class="fw-semibold mb-3">1) Column mapping</h5>

      {% macro col_select(name, required=false, hint="") -%}
      <div class="col-md-6">
        <label class="form-label">
          {{ name.replace("map_", "").replace("_", " ").title() }}
          {% if required %}<span class="text-danger">*</span>{% endif %}
        </label>
        <select class="form-select" name="{{ name }}" {% if required %}required{% endif %}>
          <option value="">-- Not mapped --</option>
          {% for c in columns %}
            <option value="{{ c }}">{{ c }}</option>
          {% endfor %}
        </select>
        {% if hint %}<div class="form-text">{{ hint }}</div>{% endif %}
      </div>
      {%- endmacro %}

      <div class="row g-3">
        {{ col_select("map_name", true, "Your item’s display name") }}
        {{ col_select("map_product_id", true, "IKEA product id (exact)") }}

        {# country mapping optional, but country required overall #}
        {{ col_select("map_country_code", false, "Country code, e.g. HU, DE (map OR set default below)") }}

        {{ col_select("map_store_ids", false, "Comma-separated store IDs (map OR set default below)") }}
        {{ col_select("map_is_active", false, "true/false/1/0") }}
        {{ col_select("map_notify_enabled", false, "true/false/1/0 (map OR set default below)") }}
        {{ col_select("map_notify_threshold", false, "Number, total stock threshold (map OR set default below)") }}
        {{ col_select("map_notify_bellow_enabled", false, "true/false/1/0 (map OR set default below)") }}
        {{ col_select("map_notify_bellow_threshold", false, "Number, total stock threshold for below alerts (optional)") }}
      </div>

      <hr class="my-4">

      <h5 class="fw-semibold mb-3">1b) Defaults for unmapped fields</h5>
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">
            Default country code <span class="text-danger">*</span>
          </label>
          <input type="text"
                name="manual_country_code"
                class="form-control"
                placeholder="e.g. HU"
                maxlength="8">
          <div class="form-text">
            Required if you don’t map a Country Code column.
          </div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Default store IDs</label>
          <input type="text"
                name="manual_store_ids"
                class="form-control"
                placeholder="Comma-separated, e.g. 123,456">
          <div class="form-text">
            Used if Store IDs column is not mapped (leave empty = all stores).
          </div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Default notifications enabled</label>
          <div class="form-check mt-1">
            <input class="form-check-input"
                  type="checkbox"
                  id="manual_notify_enabled"
                  name="manual_notify_enabled">
            <label class="form-check-label" for="manual_notify_enabled">
              Enable notifications for all imported items
            </label>
          </div>
          <div class="form-text">
            Used if Notifications column is not mapped.
          </div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Default notify threshold</label>
          <input type="number"
                min="0"
                name="manual_notify_threshold"
                class="form-control"
                placeholder="e.g. 5">
          <div class="form-text">
            Used if Threshold column is not mapped.
          </div>
        </div>
      </div>

      <hr class="my-4">

      <h5 class="fw-semibold mb-2">2) Folder assignment</h5>
      <div class="row g-2">
        <div class="col-md-4">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="folder_mode" id="folder_none" value="none" checked>
            <label class="form-check-label" for="folder_none">No folder</label>
          </div>
        </div>

        <div class="col-md-4">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="folder_mode" id="folder_existing" value="existing">
            <label class="form-check-label" for="folder_existing">Existing folder</label>
          </div>
          <select class="form-select mt-2" name="existing_folder" id="existing_folder_select" disabled>
            <option value="">-- choose --</option>
            {% for f in categories %}
              <option value="{{ f.name }}">{{ f.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-4">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="folder_mode" id="folder_new" value="new">
            <label class="form-check-label" for="folder_new">New folder</label>
          </div>
          <input class="form-control mt-2" type="text" name="new_folder" id="new_folder_input"
                 placeholder="New folder name" disabled>
        </div>
      </div>

      <div class="mt-4">
        <button class="btn btn-primary" type="submit">
          <i class="bi bi-check2-circle me-1"></i>Import items
        </button>
        <a class="btn btn-outline-secondary" href="{{ url_for('items.import_export_page') }}">Cancel</a>
      </div>
    </div>
  </div>

  <div class="card shadow-sm rounded-4">
    <div class="card-body">
      <h6 class="fw-semibold mb-2">Preview (first rows)</h6>
      <div class="table-responsive">
        <table class="table table-sm table-bordered align-middle mb-0">
          <thead class="table-light">
            <tr>
              {% for c in columns %}
                <th>{{ c }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for r in rows_preview %}
              <tr>
                {% for c in columns %}
                  <td class="small text-muted">{{ r.get(c, "") }}</td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</form>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const none = document.getElementById("folder_none");
  const existing = document.getElementById("folder_existing");
  const neu = document.getElementById("folder_new");

  const existingSelect = document.getElementById("existing_folder_select");
  const newInput = document.getElementById("new_folder_input");

  function syncFolderUI() {
    existingSelect.disabled = !existing.checked;
    newInput.disabled = !neu.checked;
  }

  [none, existing, neu].forEach(r => r.addEventListener("change", syncFolderUI));
  syncFolderUI();
});
</script>

{% endblock %}

{% extends "base.html" %}
{% block title %}Dashboard â€“ IKEA Availability{% endblock %}

{% block head_extra %}
<style>
  .dash-hero {
    background: radial-gradient(1200px circle at 0% 0%, #0d6efd15, transparent 40%),
                radial-gradient(1200px circle at 100% 0%, #20c99718, transparent 40%),
                linear-gradient(180deg, #ffffff, #f7f9fc);
    border: 1px solid #e9eef5;
  }
  .stat-tile {
    border: 1px solid #eef2f7;
    background: #fff;
    transition: transform .08s ease, box-shadow .08s ease;
  }
  .stat-tile:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(13, 110, 253, .08);
  }
  .stat-icon {
    width: 44px; height: 44px;
    border-radius: 12px;
    display:grid; place-items:center;
    background: #f1f5ff;
    color: #0d6efd;
    font-size: 1.25rem;
  }
  .chip {
    font-size: .75rem;
    border-radius: 999px;
    padding: .2rem .55rem;
    background: #f3f5f9;
    color:#6c757d;
    border: 1px solid #edf0f5;
  }
  .list-compact .list-group-item {
    padding: .65rem .9rem;
  }
  .item-dot {
    width:10px;height:10px;border-radius:50%;
    display:inline-block;margin-right:.5rem;
  }
  .dot-green { background:#198754; }
  .dot-red { background:#dc3545; }
  .dot-gray { background:#adb5bd; }

  .btn-refresh {
    position: relative;
    min-width: 190px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: .5rem;
  }
  .btn-refresh .spinner-border { display: none; }
  .btn-refresh.is-loading .spinner-border { display: inline-block; }
  .btn-refresh.is-loading .btn-label { opacity: .85; }
</style>
{% endblock %}

{% block content %}

<div class="dash-hero rounded-4 p-4 mb-4 shadow-sm"
     data-check-running="{{ '1' if check_running else '0' }}"
     data-status-url="{{ url_for('dashboard.check_all_status') }}">
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
    <div>
      <h2 class="mb-1 fw-bold">
        <i class="bi bi-speedometer2 me-2 text-primary"></i>Dashboard
      </h2>
      <div class="text-muted">
        Welcome back, <strong>{{ current_user.username }}</strong>.
        {% if last_check_ago %}
          Last full check: <span class="fw-semibold">{{ last_check_ago }}</span>
        {% else %}
          No checks yet.
        {% endif %}
      </div>
      <div class="mt-2 d-flex flex-wrap gap-2">
        <span class="chip">Total: {{ total_items }}</span>
        <span class="chip">Active: {{ active_items }}</span>
        <span class="chip">Notify enabled: {{ notify_enabled_items }}</span>
      </div>
    </div>

    <div class="d-flex align-items-center gap-2">
      <a href="{{ url_for('items.list_items') }}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-list-ul me-1"></i>Items
      </a>

      {% if current_user.can_edit_items %}
      <form id="check-all-form" method="post" action="{{ url_for('dashboard.check_all') }}" class="d-inline">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button id="check-all-btn" class="btn btn-primary btn-sm shadow-sm btn-refresh" type="submit">
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          <i class="bi bi-arrow-clockwise"></i>
          <span class="btn-label">Run availability check</span>
        </button>
      </form>

      <a href="{{ url_for('items.add_item') }}" class="btn btn-outline-primary btn-sm">
        <i class="bi bi-plus-circle me-1"></i>Add item
      </a>
      {% endif %}
    </div>
  </div>
</div>

<!-- STAT GRID -->
<div class="row g-3 mb-4">
  <div class="col-md-3 col-sm-6">
    <div class="stat-tile rounded-4 p-3 h-100 shadow-sm">
      <div class="d-flex justify-content-between">
        <div>
          <div class="text-muted small">Total items</div>
          <div class="fs-2 fw-bold">{{ total_items }}</div>
        </div>
        <div class="stat-icon"><i class="bi bi-box-seam"></i></div>
      </div>
      <div class="small text-muted mt-2">
        Active {{ active_items }} Â· Inactive {{ inactive_items }}
      </div>
    </div>
  </div>

  <div class="col-md-3 col-sm-6">
    <div class="stat-tile rounded-4 p-3 h-100 shadow-sm">
      <div class="d-flex justify-content-between">
        <div>
          <div class="text-muted small">In stock</div>
          <div class="fs-2 fw-bold text-success">{{ in_stock_items }}</div>
        </div>
        <div class="stat-icon" style="background:#eaf7f0;color:#198754;">
          <i class="bi bi-check-circle"></i>
        </div>
      </div>
      <div class="small text-muted mt-2">
        Out {{ out_of_stock_items }} Â· Unknown {{ unknown_stock_items }}
      </div>
    </div>
  </div>

  <div class="col-md-3 col-sm-6">
    <div class="stat-tile rounded-4 p-3 h-100 shadow-sm">
      <div class="d-flex justify-content-between">
        <div>
          <div class="text-muted small">Notifications</div>
          <div class="fs-2 fw-bold">{{ notify_enabled_items }}</div>
        </div>
        <div class="stat-icon" style="background:#fff4e6;color:#fd7e14;">
          <i class="bi bi-bell"></i>
        </div>
      </div>
      <div class="small text-muted mt-2">
        Items with thresholds enabled
      </div>
    </div>
  </div>

  <div class="col-md-3 col-sm-6">
    <div class="stat-tile rounded-4 p-3 h-100 shadow-sm">
      <div class="d-flex justify-content-between">
        <div>
          <div class="text-muted small">Changed (24h)</div>
          <div class="fs-2 fw-bold text-primary">{{ changed_recently_items|length }}</div>
        </div>
        <div class="stat-icon" style="background:#eef6ff;color:#0d6efd;">
          <i class="bi bi-activity"></i>
        </div>
      </div>
      <div class="small text-muted mt-2">
        Items with new stock signals
      </div>
    </div>
  </div>
</div>

<!-- HEALTH + QUICK LISTS -->
<div class="row g-3 mb-4">
  <div class="col-lg-4">
    <div class="card shadow-sm rounded-4 h-100">
      <div class="card-header bg-white border-0 pt-3 px-3">
        <div class="d-flex justify-content-between align-items-center">
          <strong>Stock health</strong>
          <small class="text-muted">{{ total_items }} items</small>
        </div>
      </div>
      <div class="card-body">
        <canvas id="healthChart" height="180"></canvas>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card shadow-sm rounded-4 h-100">
      <div class="card-header bg-white border-0 pt-3 px-3">
        <strong>Recently checked</strong>
      </div>
      <div class="card-body p-0">
        <div class="list-group list-group-flush list-compact">
          {% for it in recently_checked_items %}
            <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
               href="{{ url_for('items.detail', item_id=it.id) }}">
              <div class="text-truncate" style="max-width:70%;">
                {% if it.last_stock is none %}
                  <span class="item-dot dot-gray"></span>
                {% elif it.last_stock > 0 %}
                  <span class="item-dot dot-green"></span>
                {% else %}
                  <span class="item-dot dot-red"></span>
                {% endif %}
                <span class="fw-semibold">{{ it.name }}</span>
                <div class="small text-muted text-truncate">
                  {{ it.product_id }} Â· {{ it.country_code }}
                </div>
              </div>
              <div class="text-end small">
                <div class="fw-semibold">
                  {{ it.last_stock if it.last_stock is not none else "-" }}
                </div>
                <div class="text-muted">
                  {% if it.last_checked %}
                    {{ it.last_checked.strftime('%m-%d %H:%M') }}
                  {% else %}
                    never
                  {% endif %}
                </div>
              </div>
            </a>
          {% else %}
            <div class="list-group-item text-muted">No checks yet.</div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card shadow-sm rounded-4 h-100">
      <div class="card-header bg-white border-0 pt-3 px-3">
        <strong>Recently added</strong>
      </div>
      <div class="card-body p-0">
        <div class="list-group list-group-flush list-compact">
          {% for it in recently_added_items %}
            <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
               href="{{ url_for('items.detail', item_id=it.id) }}">
              <div class="text-truncate" style="max-width:70%;">
                <span class="fw-semibold">{{ it.name }}</span>
                <div class="small text-muted text-truncate">
                  {{ it.product_id }} Â· {{ it.country_code }} Â· {{ it.folder.name if it.folder else "Uncategorized" }}
                </div>
              </div>
              <div class="text-muted small">
                {% if it.added_at %}
                  {{ it.added_at.strftime('%m-%d') }}
                {% else %}
                  -
                {% endif %}
              </div>
            </a>
          {% else %}
            <div class="list-group-item text-muted">No items yet.</div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

{% if changed_recently_items %}
<div class="card shadow-sm rounded-4 mb-4">
  <div class="card-header bg-white border-0 pt-3 px-3">
    <strong>ðŸ”¥ Items that moved in the last 24h</strong>
    <div class="small text-muted">Quick targets to check first.</div>
  </div>
  <div class="card-body">
    <div class="row g-2">
      {% for it in changed_recently_items %}
        <div class="col-md-3 col-sm-6">
          <a class="text-decoration-none" href="{{ url_for('items.detail', item_id=it.id) }}">
            <div class="stat-tile rounded-4 p-3 h-100">
              <div class="fw-semibold text-truncate">{{ it.name }}</div>
              <div class="small text-muted">{{ it.product_id }} Â· {{ it.country_code }}</div>
              <div class="mt-2 d-flex justify-content-between align-items-center">
                <span class="badge {% if it.last_stock and it.last_stock > 0 %}bg-success{% elif it.last_stock == 0 %}bg-danger{% else %}bg-secondary{% endif %}">
                  Stock: {{ it.last_stock if it.last_stock is not none else "-" }}
                </span>
                <small class="text-muted">
                  {% if it.last_checked %}
                    {{ it.last_checked.strftime('%m-%d %H:%M') }}
                  {% endif %}
                </small>
              </div>
            </div>
          </a>
        </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}

<div class="card shadow-sm rounded-4">
  <div class="card-header bg-white border-0 pt-3 px-3">
    <strong>Latest activity</strong>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0 align-middle">
        <thead class="table-light">
          <tr>
            <th style="width:160px;">Time</th>
            <th>Item</th>
            <th style="width:120px;">Total stock</th>
            <th style="width:220px;">Probability</th>
          </tr>
        </thead>
        <tbody>
        {% for snap in latest_snapshots %}
          <tr>
            <td>{{ snap.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
            <td>
              <a href="{{ url_for('items.detail', item_id=snap.item.id) }}" class="fw-semibold text-decoration-none">
                {{ snap.item.name }}
              </a>
              <div class="small text-muted">
                {{ snap.item.product_id }} Â· {{ snap.item.country_code }}
              </div>
            </td>
            <td class="{% if snap.total_stock and snap.total_stock > 0 %}text-success fw-semibold{% endif %}">
              {{ snap.total_stock if snap.total_stock is not none else "-" }}
            </td>
            <td>{{ snap.probability_summary }}</td>
          </tr>
        {% else %}
          <tr>
            <td colspan="4" class="text-center text-muted py-3">No history yet.</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const ctx = document.getElementById("healthChart");
  if (ctx) {
    new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: ["In stock", "Out of stock", "Unknown"],
        datasets: [{
          data: [{{ in_stock_items }}, {{ out_of_stock_items }}, {{ unknown_stock_items }}],
          borderWidth: 0,
          hoverOffset: 6
        }]
      },
      options: {
        cutout: "70%",
        plugins: {
          legend: { position: "bottom" },
          tooltip: { enabled: true }
        }
      }
    });
  }

  const form = document.getElementById("check-all-form");
  const btn = document.getElementById("check-all-btn");
  const hero = document.querySelector(".dash-hero");
  if (!form || !btn || !hero) return;

  const USER_KEY = "{{ current_user.username }}";
  const LS_KEY = "dashboardCheckRunning::" + USER_KEY;
  const STATUS_URL = hero.dataset.statusUrl;
  const serverSaysRunning = hero.dataset.checkRunning === "1";

  let pollTimer = null;

  function setLoading(on) {
    btn.disabled = on;
    btn.classList.toggle("is-loading", on);
  }

  async function pollStatus() {
    try {
      const res = await fetch(STATUS_URL, { cache: "no-store" });
      if (!res.ok) throw new Error("status failed");
      const js = await res.json();

      if (!js.running) {
        localStorage.removeItem(LS_KEY);
        setLoading(false);
        if (pollTimer) clearInterval(pollTimer);
        pollTimer = null;
        window.location.reload();
      } else {
        setLoading(true);
      }
    } catch (e) {
      setLoading(true);
    }
  }

  function startPolling() {
    if (pollTimer) return;
    pollTimer = setInterval(pollStatus, 2000);
    pollStatus();
  }

  const lsRunningStamp = localStorage.getItem(LS_KEY);
  if (lsRunningStamp || serverSaysRunning) {
    setLoading(true);
    startPolling();
  }

  form.addEventListener("submit", async function (e) {
    e.preventDefault();

    localStorage.setItem(LS_KEY, String(Date.now()));
    setLoading(true);
    startPolling();

    try {
      const fd = new FormData(form);
      const res = await fetch(form.action, {
        method: "POST",
        body: fd,
        headers: { "X-Requested-With": "XMLHttpRequest" }
      });

      // Even if this fails, background might already be running.
      // So we do NOT alert here; polling decides.
      if (res.ok) {
        pollStatus();
      }
    } catch (err) {
      // Do nothing loud. Keep spinner + polling.
      console.warn("Check-all request error, continuing to poll.", err);
      startPolling();
    }
  });
});
</script>

{% endblock %}
